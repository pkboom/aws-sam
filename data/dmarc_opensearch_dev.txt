PUT _index_template/dmarc_records
{
  "index_patterns": [
    "defaultidx-*"
  ],
  "template": {
    "aliases": {
      "defaultidx-reports": {}
    },
    "settings": {
      "number_of_shards": 5,
      "number_of_replicas": 1
    },
    "mappings": {
      "properties": {
        "report_metadata": {
          "properties": {
            "org_name": {
              "type" : "keyword"
            },
            "email": {
              "type" : "keyword"
            },
            "report_id": {
              "type" : "keyword"
            },
            "date_range": {
              "properties" : {
                "begin": {
                  "type": "date"
                },
                "end": {
                  "type": "date"
                }
              }
            }
          }
        },
        "policy_published" : {
          "properties": {
            "domain" : {
              "type" : "keyword"
            },
            "adkim" : {
              "type" : "keyword"
            },
            "aspf" : {
              "type" : "keyword"
            },
            "p" : {
              "type" : "keyword"
            },
            "sp" : {
              "type" : "keyword"
            },
            "pct" : {
              "type" : "integer"
            },
            "np" : {
              "type" : "keyword"
            }
          }
        },
        "record" : {
          "properties" : {
            "row" : {
              "properties" : {
                "source_ip" : {
                  "type": "ip"
                },
                "source_ip_details": {
                  "properties" : {
                    "country_iso_code": {
                      "type": "keyword"
                    },
                    "organization_name": {
                      "type": "keyword"
                    },
                    "host": {
                      "type" : "keyword"
                    }
                  }
                },
                "count": {
                  "type": "integer"
                },
                "policy_evaluated": {
                  "properties": {
                    "disposition" : {
                      "type": "keyword"
                    },
                    "dkim" : {
                      "type": "keyword"
                    },
                    "spf" : {
                      "type": "keyword"
                    },
                    "reason": {
                      "properties" : {
                        "type": {
                          "type": "keyword"
                        },
                        "comment" : {
                          "type" : "text"
                        }
                      }
                    }
                  }
                }
              }
            },
            "identifier": {
              "properties" : {
                "envelope_to" : {
                  "type": "keyword"
                },
                "envelope_from" : {
                  "type": "keyword"
                },
                "header_from" : {
                  "type": "keyword"
                }
              }
            },
            "auth_results": {
              "properties" : {
                "dkim_1": {
                  "properties": {
                    "domain" : {
                      "type": "keyword"
                    },
                    "selector" : {
                      "type": "keyword"
                    },
                    "result" : {
                      "type": "keyword"
                    },
                    "human_result" : {
                      "type": "text"
                    }
                  }
                },
                "dkim_2": {
                  "properties": {
                    "domain" : {
                      "type": "keyword"
                    },
                    "selector" : {
                      "type": "keyword"
                    },
                    "result" : {
                      "type": "keyword"
                    },
                    "human_result" : {
                      "type": "text"
                    }
                  }
                },
                
                "spf": {
                  "properties" : {
                    "domain" : {
                      "type": "keyword"
                    },
                    "scope" : {
                      "type": "keyword"
                    },
                    "result" : {
                      "type": "keyword"
                    }
                  }
                }
              }
            }
          }
        }
      }
    }
  }
}

GET _index_template/dmarc_records

DELETE /defaultidx-1

POST defaultidx-1/_doc
{
  "report_metadata" : {
    "org_name" : "google.com",
    "email" : "noreply-dmarc-support@google.com",
    "report_id" : "1632628712446833086",
    "date_range": {
      "begin" : 1693958400,
      "end" : 1694044799
    }
  },
  "policy_published" : {
    "domain" : "spotify.com",
    "adkim": "r",
    "aspf": "r",
    "p" : "reject",
    "sp" : "reject",
    "pct" : 100,
    "np" : "reject"
  },
  "record" : {
    "row" : {
      "source_ip" : "194.199.194.131",
      "count": 3,
      "policy_evaluated": {
        "disposition": "reject",
        "dkim": "fail",
        "spf": "fail",
        "reason": {
          "type": "forwarded",
          "comment": "looks forwarded, downgrade to quarantine with phishing warning"
        }
      }
    },
    "identifiers": {
      "header_from": "spotify.com"
    },
    "auth_results": {
      "dkim_auth" : {
        "domain" : "spotify.com",
        "result" : "fail",
        "selector": "s1"
      },
      "spf_auth": {
        "domain" : "em.spotify.com",
        "result" : "softfail"
      }
    }
  }
}

GET defaultidx-2/_search
{
  "size": 1,
  
  "aggs": {
    "dkim_domains": {
      "terms": {
        "field": "record.auth_results.dkim_auth.domain",
        "size": 10
      },
      "aggs": {
        "total": {
          "sum": {
            "field": "record.row.count"
          }
        }
      }
    },
    "spf_domains": {
      "terms": {
        "field": "record.auth_results.spf_auth.domain",
        "size": 10
      },
      "aggs": {
        "total": {
          "sum": {
            "field": "record.row.count"
          }
        }
      }
    }
  }
}

GET defaultidx-1

GET defaultidx-2/_search



GET _index_template/dmarc_records